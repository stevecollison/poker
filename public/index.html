<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scrum Poker</title>
  <link rel="stylesheet" href="/styles/output.css">
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-xl mx-auto bg-white shadow rounded p-6 space-y-4">
    <h1 class="text-2xl font-bold">Scrum Poker</h1>
    <input id="name" type="text" placeholder="Your name" class="border p-2 w-full rounded">
    <input id="sessionId" type="text" placeholder="Session ID" class="border p-2 w-full rounded">
    <button id="join" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700">Join</button>

    <div id="vote-panel" class="hidden space-y-4">
      <div class="flex gap-2 justify-center">
        <button class="vote-btn bg-gray-200 p-2 rounded" data-value="1">1</button>
        <button class="vote-btn bg-gray-200 p-2 rounded" data-value="2">2</button>
        <button class="vote-btn bg-gray-200 p-2 rounded" data-value="3">3</button>
        <button class="vote-btn bg-gray-200 p-2 rounded" data-value="5">5</button>
        <button class="vote-btn bg-gray-200 p-2 rounded" data-value="8">8</button>
        <button class="vote-btn bg-gray-200 p-2 rounded" data-value="13">13</button>
      </div>
      <div class="flex gap-2 justify-center">
        <button id="reveal" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Reveal</button>
        <button id="clear" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Clear</button>
      </div>
      <div id="users" class="pt-4"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const socket = io();
    const joinBtn = document.getElementById('join');
    const nameInput = document.getElementById('name');
    const sessionIdInput = document.getElementById('sessionId');
    const votePanel = document.getElementById('vote-panel');
    const usersDiv = document.getElementById('users');
    const revealBtn = document.getElementById('reveal');
    const clearBtn = document.getElementById('clear');

    let selfId;

    const renderState = ({ users, votesRevealed }) => {
      usersDiv.innerHTML = '';
      const currentUser = selfId ? users[selfId] : undefined;
      setAdminControlsState(Boolean(currentUser?.isAdmin));

      Object.values(users).forEach(({ name, vote }) => {
        const displayVote = votesRevealed ? vote : (vote ? 'âœ“' : '');
        usersDiv.innerHTML += `<div class="p-2 border-b">${name}: <strong>${displayVote ?? ''}</strong></div>`;
      });
    };

    joinBtn.addEventListener('click', () => {
      const name = nameInput.value.trim();
      const sessionId = sessionIdInput.value.trim();

      if (!name || !sessionId) {
        alert('Both name and session ID are required.');
        return;
      }

      socket.emit('join', { sessionId, name }, (response) => {
        if (!response || !response.success) {
          const message = response?.message || 'Unable to join the session. Please try again.';
          alert(message);
          return;
        }

        selfId = response.selfId;
        votePanel.classList.remove('hidden');
        setAdminControlsState(response.isAdmin);
        renderState(response.state);
      });
    });

    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        socket.emit('vote', btn.dataset.value);
      });
    });

    const setAdminControlsState = (isAdmin) => {
      const controls = [revealBtn, clearBtn];
      controls.forEach(btn => {
        btn.disabled = !isAdmin;
        btn.classList.toggle('opacity-50', !isAdmin);
        btn.classList.toggle('cursor-not-allowed', !isAdmin);
      });
    };

    setAdminControlsState(false);

    revealBtn.addEventListener('click', () => {
      socket.emit('reveal');
    });

    clearBtn.addEventListener('click', () => {
      socket.emit('clear');
    });

    socket.on('state', (state) => {
      if (state?.users) {
        renderState(state);
      }
    });

    socket.on('disconnect', () => {
      selfId = undefined;
      setAdminControlsState(false);
    });

    socket.on('error', (message) => {
      if (typeof message === 'string') {
        alert(message);
      }
    });
  </script>
</body>
</html>
